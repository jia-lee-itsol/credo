rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users Collection
    match /users/{userId} {
      // 읽기: 로그인한 사용자는 모든 사용자 정보 읽기 가능
      allow read: if request.auth != null;
      
      // 쓰기: 자신의 문서만 생성/수정 가능
      // userId는 문서 ID와 동일하므로 데이터에 포함되지 않음
      allow create: if request.auth != null 
        && request.auth.uid == userId;
      
      allow update: if request.auth != null 
        && request.auth.uid == userId;
      
      allow delete: if request.auth != null 
        && request.auth.uid == userId;
    }
    
    // Posts Collection (향후 구현)
    match /posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null 
        && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if request.auth != null 
        && (resource.data.authorId == request.auth.uid);
    }
    
    // Comments Collection (향후 구현)
    match /comments/{commentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null 
        && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if request.auth != null 
        && resource.data.authorId == request.auth.uid;
    }
    
    // Post Likes Collection (향후 구현)
    match /postLikes/{likeId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null 
        && resource.data.userId == request.auth.uid;
    }
    
    // Notifications Collection
    match /notifications/{notificationId} {
      // 읽기: 자신의 알림만 읽기 가능
      allow read: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // 생성: 누구나 알림 생성 가능 (다른 사용자에게 알림을 보낼 수 있음)
      allow create: if request.auth != null;
      
      // 수정/삭제: 자신의 알림만 수정/삭제 가능
      allow update, delete: if request.auth != null 
        && resource.data.userId == request.auth.uid;
    }
    
    // Daily Meditation Comments Collection
    // 날짜별 묵상 댓글: daily_meditation_comments/{date}/comments/{commentId}
    match /daily_meditation_comments/{date} {
      // 상위 문서에 대한 접근 권한 (서브컬렉션 접근을 위해 필요할 수 있음)
      // 읽기는 로그인 없이도 가능 (보기 허용)
      allow read: if true;
      
      // 서브컬렉션: comments
      match /comments/{commentId} {
        // 읽기: 모든 사용자가 댓글 읽기 가능 (로그인 불필요)
        allow read: if true;
        
        // 생성: 로그인한 사용자는 댓글 작성 가능 (작성자 ID 확인)
        allow create: if request.auth != null 
          && request.resource.data.authorId == request.auth.uid;
        
        // 수정/삭제: 자신이 작성한 댓글만 수정/삭제 가능
        allow update, delete: if request.auth != null 
          && resource.data.authorId == request.auth.uid;
      }
    }
  }
}

