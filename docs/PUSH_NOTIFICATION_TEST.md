# 푸시 알림 기능 테스트 가이드

**작성일**: 2025-12-15  
**마지막 업데이트**: 2025-12-16  
**대상**: Firebase Cloud Functions 푸시 알림 기능

---

## 테스트 전 준비사항

### 1. 필수 조건 확인

- [ ] Firebase 프로젝트에 Functions가 배포되어 있음
- [ ] 테스트용 사용자 계정 2개 이상 준비
  - 계정 A: 공지글 작성자 / 게시글 작성자
  - 계정 B: 알림 수신자 (계정 A와 다른 성당 소속 또는 같은 성당 소속)
- [ ] 테스트 기기에서 FCM 토큰이 정상적으로 생성됨
  - **중요**: iOS 시뮬레이터에서는 FCM 토큰을 받을 수 없습니다. 실제 iOS 기기에서 테스트해야 합니다.
  - Android 에뮬레이터는 Google Play Services가 설치된 경우에만 가능합니다.
- [ ] 앱에서 알림 권한이 허용되어 있음

### 2. Cloud Functions 로그 확인 준비

```bash
# Functions 로그 실시간 확인
firebase functions:log

# 특정 함수 로그만 확인
firebase functions:log --only onPostCreated
firebase functions:log --only onCommentCreated
```

---

## 테스트 시나리오 1: 공지글 작성 시 알림 전송

### 목적
공지글(`type: "official"`, `category: "notice"`) 작성 시 해당 성당에 소속된 사용자에게 알림이 전송되는지 확인

### 테스트 절차

#### 1단계: 사전 준비
1. **계정 A (작성자)**:
   - 로그인
   - 성당 설정 확인 (`main_parish_id` 확인)
   - FCM 토큰 확인 (Firestore Console에서 `users/{userId}` 문서의 `fcmToken` 필드 확인)

2. **계정 B (수신자)**:
   - 로그인
   - **같은 성당에 소속되어 있는지 확인** (`main_parish_id`가 계정 A와 동일)
   - FCM 토큰 확인

3. **Cloud Functions 로그 준비**:
   ```bash
   firebase functions:log --only onPostCreated
   ```

#### 2단계: 공지글 작성
1. 계정 A로 로그인
2. 커뮤니티 화면에서 게시글 작성
3. **중요**: 다음 설정 확인
   - `type`: "official" (공식 게시글)
   - `category`: "notice" (공지)
   - `parishId`: 계정 A의 `main_parish_id`와 동일
4. 제목과 내용 입력 후 게시

#### 3단계: 결과 확인

**계정 B (알림 수신자)**:
- [ ] 알림이 수신되었는지 확인
- [ ] 알림 제목이 게시글 제목과 일치하는지 확인
- [ ] 알림 내용이 게시글 내용의 처음 100자와 일치하는지 확인
- [ ] 알림 탭 시 게시글 상세 화면으로 이동하는지 확인

**계정 A (작성자)**:
- [ ] 알림이 **수신되지 않았는지** 확인 (작성자는 제외되어야 함)

**Cloud Functions 로그**:
```bash
# 예상 로그 메시지
✅ 성당 {parishId}에 소속된 사용자 수: {count}
✅ 전송할 알림 개수: {count}
✅ 알림 전송 완료: 성공 {count}개, 실패 {count}개
```

---

## 테스트 시나리오 2: 댓글 작성 시 알림 전송

### 목적
댓글 작성 시 게시글 작성자에게 알림이 전송되는지 확인 (댓글 작성자 자신은 제외)

### 테스트 절차

#### 1단계: 사전 준비
1. **계정 A (게시글 작성자)**:
   - 로그인
   - FCM 토큰 확인

2. **계정 B (댓글 작성자)**:
   - 로그인
   - FCM 토큰 확인

3. **Cloud Functions 로그 준비**:
   ```bash
   firebase functions:log --only onCommentCreated
   ```

#### 2단계: 게시글 작성
1. 계정 A로 로그인
2. 일반 게시글 작성 (공지글 아님)
3. 게시 완료

#### 3단계: 댓글 작성
1. 계정 B로 로그인
2. 계정 A가 작성한 게시글 상세 화면으로 이동
3. 댓글 작성 후 제출

#### 4단계: 결과 확인

**계정 A (게시글 작성자)**:
- [ ] 알림이 수신되었는지 확인
- [ ] 알림 제목이 "新しいコメント"인지 확인
- [ ] 알림 내용이 "댓글 작성자명: 댓글 내용" 형식인지 확인
- [ ] 알림 탭 시 해당 게시글 상세 화면으로 이동하는지 확인

**계정 B (댓글 작성자)**:
- [ ] 알림이 **수신되지 않았는지** 확인 (자신의 댓글이므로 제외)

**Cloud Functions 로그**:
```bash
# 예상 로그 메시지
✅ 댓글 알림 전송 완료: 게시글 {postId}, 댓글 {commentId}, 메시지 ID: {messageId}
```

---

## 테스트 시나리오 3: 예외 상황 테스트

### 3-1. 작성자가 자신에게 알림을 받지 않는지 확인

**테스트**:
1. 계정 A로 로그인
2. 공지글 작성
3. 계정 A에서 알림이 수신되지 않는지 확인

**예상 결과**: 알림 수신 없음

### 3-2. FCM 토큰이 없는 사용자는 제외되는지 확인

**테스트**:
1. Firestore Console에서 테스트 사용자의 `fcmToken` 필드 삭제
2. 공지글 작성
3. Cloud Functions 로그에서 해당 사용자가 제외되었는지 확인

**예상 결과**: 
- 로그에 "전송할 알림 개수"가 FCM 토큰이 있는 사용자 수만큼 표시됨
- FCM 토큰이 없는 사용자는 제외됨

### 3-3. 댓글 작성자가 게시글 작성자와 같을 때 알림이 전송되지 않는지 확인

**테스트**:
1. 계정 A로 로그인
2. 게시글 작성
3. 같은 계정 A로 댓글 작성
4. 알림이 수신되지 않는지 확인

**예상 결과**: 
- Cloud Functions 로그에 "댓글 작성자가 게시글 작성자와 동일하므로 알림을 전송하지 않습니다." 메시지
- 알림 수신 없음

### 3-4. 공지글이 아닌 게시글은 알림이 전송되지 않는지 확인

**테스트**:
1. 계정 A로 로그인
2. 일반 게시글 작성 (`type: "normal"` 또는 `category: "community"`)
3. Cloud Functions 로그 확인

**예상 결과**:
- 로그에 "게시글 {postId}는 공지글이 아닙니다" 메시지
- 알림 전송 없음

---

## 문제 해결 가이드

### 문제 1: 알림이 전송되지 않음

**확인 사항**:
1. **FCM 토큰 확인**:
   ```bash
   # Firestore Console에서 확인
   users/{userId}/fcmToken 필드가 존재하는지 확인
   ```
   
   **FCM 토큰이 없는 경우**:
   - 앱을 재시작하거나 다시 로그인하여 토큰이 자동 저장되는지 확인
   - 클라이언트 앱에서 `PushNotificationService`가 정상적으로 초기화되었는지 확인
   - **중요**: iOS 시뮬레이터에서는 FCM 토큰을 받을 수 없습니다. 실제 iOS 기기에서 테스트해야 합니다.
   - Android 에뮬레이터는 Google Play Services가 설치된 경우에만 가능합니다.
   - 로그인 시 `authStateProvider`를 통해 토큰이 자동 저장되는지 확인 (`lib/main.dart`)

2. **Cloud Functions 로그 확인**:
   ```bash
   firebase functions:log --only onPostCreated
   # 또는
   firebase functions:log --only onCommentCreated
   ```
   - 에러 메시지 확인
   - "전송할 알림 개수"가 0인지 확인

3. **사용자 소속 성당 확인**:
   - 공지글 알림: `users` 컬렉션의 `main_parish_id`가 게시글의 `parishId`와 일치하는지 확인
   - Firestore Console에서 쿼리:
     ```
     users where main_parish_id == {parishId}
     ```

4. **앱에서 알림 권한 확인**:
   - iOS: 설정 > 알림 > Credo 앱
   - Android: 설정 > 앱 > Credo > 알림

### 문제 2: 알림은 전송되지만 앱으로 이동하지 않음

**확인 사항**:
1. **알림 데이터 확인**:
   - Cloud Functions에서 전송하는 `data` 필드 확인
   - `postId`, `parishId`, `type` 필드가 포함되어 있는지 확인

2. **클라이언트 코드 확인**:
   - `push_notification_service.dart`의 `_handleMessageOpenedApp` 메서드 확인
   - `AppRoutes.postDetailPath`가 올바르게 호출되는지 확인

### 문제 3: Cloud Functions 에러

**확인 사항**:
1. **에러 로그 확인**:
   ```bash
   firebase functions:log
   ```

2. **일반적인 에러**:
   - FCM 토큰이 유효하지 않음: 토큰이 만료되었거나 무효화됨
   - Firestore 권한 오류: Firestore Rules 확인
   - 메시지 포맷 오류: 알림 데이터 구조 확인

3. **에러 해결**:
   - FCM 토큰 무효화: 클라이언트에서 토큰 재생성 필요
   - Firestore 권한: Rules에서 Functions 서비스 계정 권한 확인

---

## 테스트 체크리스트

### 공지글 알림 테스트
- [ ] 공지글 작성 시 소속 성당 사용자에게 알림 전송됨
- [ ] 작성자에게는 알림이 전송되지 않음
- [ ] 알림 제목이 게시글 제목과 일치함
- [ ] 알림 내용이 게시글 내용의 처음 100자와 일치함
- [ ] 알림 탭 시 게시글 상세 화면으로 이동함
- [ ] Cloud Functions 로그에 성공 메시지 표시됨

### 댓글 알림 테스트
- [ ] 댓글 작성 시 게시글 작성자에게 알림 전송됨
- [ ] 댓글 작성자 자신에게는 알림이 전송되지 않음
- [ ] 알림 제목이 "新しいコメント"임
- [ ] 알림 내용이 "작성자명: 댓글 내용" 형식임
- [ ] 알림 탭 시 해당 게시글 상세 화면으로 이동함
- [ ] Cloud Functions 로그에 성공 메시지 표시됨

### 예외 상황 테스트
- [ ] 작성자가 자신의 게시글에 댓글을 달면 알림이 전송되지 않음
- [ ] FCM 토큰이 없는 사용자는 알림에서 제외됨
- [ ] 공지글이 아닌 게시글은 알림이 전송되지 않음
- [ ] `parishId`가 없는 게시글은 알림이 전송되지 않음

---

## 테스트 결과 기록

### 테스트 일시
- 날짜: ___________
- 테스터: ___________

### 테스트 결과
- 공지글 알림: ✅ 성공 / ❌ 실패
- 댓글 알림: ✅ 성공 / ❌ 실패
- 예외 상황: ✅ 성공 / ❌ 실패

### 발견된 문제
1. ___________
2. ___________

### 해결 방법
1. ___________
2. ___________

---

## 다음 단계

테스트가 성공적으로 완료되면:
1. 프로덕션 환경에서 모니터링 설정
2. 사용자 피드백 수집
3. 알림 설정 기능 추가 (사용자가 알림 수신 여부 선택)

테스트 중 문제가 발견되면:
1. Cloud Functions 로그 확인
2. 문제 원인 분석
3. 코드 수정 및 재배포
